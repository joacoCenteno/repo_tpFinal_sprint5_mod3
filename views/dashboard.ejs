<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listado de Paises</title>
</head>
    <style>
        .mensajeSucces{
            position: fixed;
            top:0;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            border-bottom-left-radius: 7px;
            border-bottom-right-radius: 7px;
            z-index: 1000;
            opacity: 0;
            transition: opacity .5s ease;
        }

        .mensajeSucces.mostrar{
            opacity: 1;
        }

        #mensaje{
            font-size: medium;
            font-weight: 600;
        }

        #formularioConfirmacion{
            position: fixed;
            top:0;
              left: 50%;
              transform: translateX(-50%);
            width: 400px;
            text-align: center;
            padding-top: 40px;
            padding-bottom: 40px;
            background-color: rgb(245,247,248);
            box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 8px;
            z-index: 1000;
            opacity: 0;
        }

        #formularioConfirmacion.mostrar{
            opacity: 1;
        }

        #section_filter{
            z-index: 1001;
        }
    </style>
<body>
    
    <!--MENSAJE QUE APARECE EN CASO DE CREAR, ELIMINAR O MODIFICAR CON EXITO UN PAIS-->
    <div id="mensajeSucces" class="mensajeSucces bg-green-300 w-150 py-3 text-center " >
        <span id="mensaje"></span>
    </div>

    <!--MODAL QUE APARECE EN CASO DE QUERER ELIMINAR UN PAIS-->
    <div id="formularioConfirmacion">
        <form action="" method="post" id="formularioEliminacion">
            <h2 class="text-2xl font-bold">Confirmar Eliminación?</h2>
            <div class="flex justify-center mt-5 gap-5">
            <button type="button" class="text-white hidden bg-green-300 py-1 px-4 rounded-xs" id="btn_form_cancelar">Cancelar</button>
            <button type="submit" class="text-white bg-red-300 py-1 px-4  hidden rounded-xs cursor-pointer" id="btn_form_confirmar">Confirmar</button>
            </div>

        </form>
    </div>

    <!--FORMULARIO PARA EL FILTRADO DE PAISES-->
    <section class="relative pt-3 pb-6 pl-20" id="section_filter">
        <form action="/paises?pagina=1" method="get">
            <select name="filterType" id="tipoFiltrado" class="bg-sky-300 text-white py-1 px-2" onchange="controlSelect()">
                
                <option value="nombre">Por Nombre</option>
                <option value="poblacion">Por Poblacion</option>
                
            </select>

            <input type="text" name="value1" id="valor1" placeholder="Filtro 1" value="<%= filtros.valor1 || ''%>" required class=" py-1 mt-1 border border-green-100 text-sky-300">
            <input type="text" name="value2" id="valor2" placeholder="Filtro 2" value="<%= filtros.valor2 || ''%>" disabled required class=" py-1 mt-1 border border-green-100 text-sky-300">
        
            <button type="submit" class="text-sky-400 border py-2 px-6 rounded-md cursor-pointer ml-5">Filtrar</button>
        </form>   
        
        <!--MENSAJE QUE APARECE EN CASO DE NO ENCONTRAR COINCIDENCIA EN EL FILTRADO-->
        <div id="mensaje" class="mt-3 m-auto w-200 text-center">
            
            <span class="text-2xl text-orange-400"><%= mensaje %></span>
        </div>
    </section>
    <main class="m-auto w-fit h-133">
        <table class="mb-5">
            <thead class="bg-green-400 text-white">
                <tr>
                    <th class="font-normal py-2">Bandera</th>
                    <th class="font-normal">Nombre</th>
                    <th class="font-normal">Capital/es</th>
                    <th class="font-normal px-20">Frontera/as</th>
                    <th class="font-normal px-10">Zona Horaria</th>
                    <th class="font-normal px-10">Area</th>
                    <th class="font-normal px-10">Poblacion</th>
                    <th class="font-normal px-2">Indice Desigualdad</th>
                </tr>
            </thead>
            <tbody>
                <!--MUESTRA DE LOS PAISES EN UNA TABLA-->
                <%  paises_formateados.forEach(pais => { %>
                    <tr class="">
                        <th class="py-2 font-normal text-xs align-middle"><img src=<%= pais.banderaPais %> alt="Imagen No Disponible" width="50" height="30"></th>
                        <th class="font-normal text-sm align-middle"><%= pais.nombrePais %></th>
                        <th class="font-normal text-sm align-middle"><%= pais.capitalPais.length <= 1 ? pais.capitalPais[0] : pais.capitalPais.join('-') %></th>
                        <th class="font-normal text-sm align-middle"><%= (pais.fronteraPais.length <= 1 ? pais.fronteraPais[0] : pais.fronteraPais.join(', ')) || "NO TIENE" %></th>
                        <th class="font-normal text-sm align-middle"><%= pais.zonaHorariaPais.length <= 1 ? pais.zonaHorariaPais[0] : pais.zonaHorariaPais.join(', ') %></th>
                        <th class="font-normal text-sm align-middle"><%= pais.areaPais %></th>
                        <th class="font-normal text-sm align-middle"><%= pais.poblacionPais %></th>
                        <th class="font-normal text-sm align-middle"><%= pais.desigualdadPais %></th>
                        <th class="font-normal flex gap-4 px-2 h-full items-center py-4">
                            <!--BOTON PARA EDITAR EL PAIS, PASANDO EN EL PATH EL ID DEL PAIS-->
                            <a href="/pais/editar-pais/<%= pais.Id %>"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="oklch(87.1% 0.15 154.449)" class="size-6">
                            <path d="M21.731 2.269a2.625 2.625 0 0 0-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 0 0 0-3.712ZM19.513 8.199l-3.712-3.712-8.4 8.4a5.25 5.25 0 0 0-1.32 2.214l-.8 2.685a.75.75 0 0 0 .933.933l2.685-.8a5.25 5.25 0 0 0 2.214-1.32l8.4-8.4Z" />
                            <path d="M5.25 5.25a3 3 0 0 0-3 3v10.5a3 3 0 0 0 3 3h10.5a3 3 0 0 0 3-3V13.5a.75.75 0 0 0-1.5 0v5.25a1.5 1.5 0 0 1-1.5 1.5H5.25a1.5 1.5 0 0 1-1.5-1.5V8.25a1.5 1.5 0 0 1 1.5-1.5h5.25a.75.75 0 0 0 0-1.5H5.25Z" />
                            </svg>

                            </a>
                            <!--BOTON PARA ELIMINAR EL PAIS (SE PASA SU ID A LA FUNCION confirmacionModal())-->
                            <button onclick="confirmacionModal('<%= pais.Id %>')" class="cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="oklch(87.1% 0.15 154.449)" class="size-6">
                            <path fill-rule="evenodd" d="M16.5 4.478v.227a48.816 48.816 0 0 1 3.878.512.75.75 0 1 1-.256 1.478l-.209-.035-1.005 13.07a3 3 0 0 1-2.991 2.77H8.084a3 3 0 0 1-2.991-2.77L4.087 6.66l-.209.035a.75.75 0 0 1-.256-1.478A48.567 48.567 0 0 1 7.5 4.705v-.227c0-1.564 1.213-2.9 2.816-2.951a52.662 52.662 0 0 1 3.369 0c1.603.051 2.815 1.387 2.815 2.951Zm-6.136-1.452a51.196 51.196 0 0 1 3.273 0C14.39 3.05 15 3.684 15 4.478v.113a49.488 49.488 0 0 0-6 0v-.113c0-.794.609-1.428 1.364-1.452Zm-.355 5.945a.75.75 0 1 0-1.5.058l.347 9a.75.75 0 1 0 1.499-.058l-.346-9Zm5.48.058a.75.75 0 1 0-1.498-.058l-.347 9a.75.75 0 0 0 1.5.058l.345-9Z" clip-rule="evenodd" />
                            </svg>
                            </button>
                        </th>
                    </tr>
                <% }); %>
                <!--SECCION DE TOTALES-->
                <tr class="bg-sky-300 text-white">
                    <th class="h-10">TOTALES</th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th><%= suma_area %></th>
                    <th><%= suma_poblacion %></th>
                    <th><%= promedio_gini %></th>
                </tr>
            </tbody>
        </table>

        <!--SECCION PARA LA NAVEGACION ENTRE LAS PAGINAS (SE PASAN LOS FILTROS TAMBIEN)-->
        <div class=" m-auto text-center flex justify-center">
            <% if(pagina > 1){ %>
                <a href="/paises?pagina=<%= pagina - 1 %><% if(filtros.filterType){ %>&filterType=<%= filtros.filterType %><% } %><% if(filtros.value1){ %>&value1=<%= filtros.value1 %><% } %><% if(filtros.value2){ %>&value2=<%= filtros.value2 %><% } %>"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="oklch(87.1% 0.15 154.449)" class="size-6">
  <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm-4.28 9.22a.75.75 0 0 0 0 1.06l3 3a.75.75 0 1 0 1.06-1.06l-1.72-1.72h5.69a.75.75 0 0 0 0-1.5h-5.69l1.72-1.72a.75.75 0 0 0-1.06-1.06l-3 3Z" clip-rule="evenodd" />
</svg>
</a>
            <% } %>
            <span class="text-green-300 px-3">Página <%= pagina %> de <%= paginas_totales %></span>
            <% if(pagina < paginas_totales){ %>
                <a href="/paises?pagina=<%= pagina + 1 %><% if(filtros.filterType){ %>&filterType=<%= filtros.filterType %><% } %><% if(filtros.value1){ %>&value1=<%= filtros.value1 %><% } %><% if(filtros.value2){ %>&value2=<%= filtros.value2 %><% } %>"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="oklch(87.1% 0.15 154.449)" class="size-6">
  <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm4.28 10.28a.75.75 0 0 0 0-1.06l-3-3a.75.75 0 1 0-1.06 1.06l1.72 1.72H8.25a.75.75 0 0 0 0 1.5h5.69l-1.72 1.72a.75.75 0 1 0 1.06 1.06l3-3Z" clip-rule="evenodd" />
</svg>

</a>
            <% } %>
        </div>
        <!--EN CASO DE QUE filtroActivos SEA TRUE, SE MOSTRARA EL BOTON PARA LA DESCARGA DEL CSV-->
        <div>
        <% if(filtrosActivos) { %>
            <form action="/paises/generar-csv" method="get">
                <input type="hidden" name="filterType" value="<%= filtros.filterType %>">
                <input type="hidden" name="value1" value="<%= filtros.value1 %>">
                <input type="hidden" name="value2" value="<%= filtros.value2 %>">
                <button type="submit" class="bg-sky-300 text-white px-4 py-2 flex cursor-pointer rounded-md">
                    <svg class="fill-white size-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-3">
                    <path fill-rule="evenodd" d="M9.75 6.75h-3a3 3 0 0 0-3 3v7.5a3 3 0 0 0 3 3h7.5a3 3 0 0 0 3-3v-7.5a3 3 0 0 0-3-3h-3V1.5a.75.75 0 0 0-1.5 0v5.25Zm0 0h1.5v5.69l1.72-1.72a.75.75 0 1 1 1.06 1.06l-3 3a.75.75 0 0 1-1.06 0l-3-3a.75.75 0 1 1 1.06-1.06l1.72 1.72V6.75Z" clip-rule="evenodd" />
                    <path d="M7.151 21.75a2.999 2.999 0 0 0 2.599 1.5h7.5a3 3 0 0 0 3-3v-7.5c0-1.11-.603-2.08-1.5-2.599v7.099a4.5 4.5 0 0 1-4.5 4.5H7.151Z" />
                    </svg>  GENERAR CSV</button>
            </form>
        <% } %>            
        </div>


        
    </main>
</body>
<script>
    //SE VERIFICA QUE TIPO DE MENSAJE APARECE EN EL PATH (QUE NO SEAN UNDEFINED)
  const successCreate = "<%- typeof successCreate !== 'undefined' ? successCreate : '' %>";
  const successUpdate = "<%- typeof successUpdate !== 'undefined' ? successUpdate : '' %>";
  const successDelete = "<%- typeof successDelete !== 'undefined' ? successDelete : '' %>";

  //DIFERENTES IF QUE SE EJECUTAN, PARA POSTERIORMENTE HACER EL LLAMADO ALA FUNCION mensajeSucces CON EL MENSAJE EN SI
  if (successCreate === '1') {
      mensajeSuccess('Creación Realizada Con Éxito!');
  }
  if (successUpdate === '1') {
      mensajeSuccess('Actualización Realizada Con Éxito!');
  }
  if (successDelete === '1') {
      mensajeSuccess('Eliminación Realizada Con Éxito!');

  }


//Funcion para el envio de mensajes
  function mensajeSuccess(msg){
    const div_mensaje = document.getElementById('mensajeSucces');
    const mensaje = document.getElementById('mensaje');
    div_mensaje.classList.add("mostrar"); //Se maneja con la existencia o no de la clase "mostrar"
    mensaje.textContent = msg;

    //El mensaje sera visible por 3 segundos
    setTimeout(()=>{
        div_mensaje.classList.remove('mostrar');
    },3000);
  }

  //Funcion para la aparicion del modal de eliminacion
  function confirmacionModal(id_pais){
    const div_form = document.getElementById('formularioConfirmacion');
    const form = document.getElementById('formularioEliminacion');
    const btn_form_cancelar = document.getElementById('btn_form_cancelar');
    const btn_form_confirmar = document.getElementById('btn_form_confirmar');

    div_form.style.zIndex = 1010; //Se aumenta el hidden (el div del formulario de filtro tiene zIndex de 1001)
    //Se eliminan de los botones la clase hidden
    btn_form_cancelar.classList.remove('hidden'); 
    btn_form_confirmar.classList.remove('hidden');

    //Se añade la clase mostrar
    div_form.classList.add('mostrar');

    //Se setea el atributo action en el formulario, ejecutando el delete pasando el id de pais obtenido del parametro
    form.setAttribute('action',`/pais/eliminar/${id_pais}?_method=DELETE`);

    //En caso de dar click al boton de cancelar
    btn_form_cancelar.addEventListener('click',()=>{
        div_form.style.zIndex = 1000; //Se setea el zIndex original
        //Se agregan los hidden a los botones
        btn_form_cancelar.classList.add('hidden');
        btn_form_confirmar.classList.add('hidden');
        div_form.classList.remove('mostrar'); //Se remueve la clase mostrar
    })
  }

  //Funcion para controlar que en caso de que el valor del select sea "nombre", el segundo input se deshabilite
  const controlSelect = () =>{
    const select_filter = document.getElementById('tipoFiltrado');
    const input_value2 = document.getElementById('valor2');

    const change = select_filter.value == 'poblacion' ? input_value2.removeAttribute('disabled') : input_value2.disabled = true;
    
  }

</script>
</html>